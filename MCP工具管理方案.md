# MCP工具管理方案设计文档

## 产品概念

基于"MCP管理员智能体"的工具管理方案，用户只需描述需求，智能体自动完成MCP工具的搜索、评估、推荐和安装，真正实现"数字员工自主学习新技能"。

## 界面设计

### Settings弹窗结构

```
⚙️ 系统设置                                [×]
┌─────────────────────────────────────────────────────┐
│ 📋 设置选项          │  🔧 MCP工具管理               │
│ ┌─────────────────┐  │  ┌─────────────────────────┐ │
│ │ 🔧 MCP工具      │◀─┤  │ 📦 已安装工具 (5个)      │ │
│ │ 🎨 界面主题     │  │  │ ✅ 邮件发送 (内置)      │ │
│ │ 🔔 通知设置     │  │  │ ✅ PostgreSQL          │ │
│ │ 📊 数据统计     │  │  │ ✅ 文件操作            │ │
│ │ ℹ️  关于系统     │  │  │ 🔴 Redis (已禁用)      │ │
│ └─────────────────┘  │  │ ✅ Web抓取             │ │
│                     │  │                        │ │
│                     │  │ 🤖 MCP管理员           │ │
│                     │  │ ┌───────────────────────┐ │
│                     │  │ │ 描述你需要的工具功能... │ │
│                     │  │ │ 例如: "我需要连接Redis" │ │
│                     │  │ │ 例如: "发送微信通知"    │ │
│                     │  │ │         [呼叫管理员] │ │
│                     │  │ └───────────────────────┘ │
│                     │  └─────────────────────────┘ │
│ [关闭]               │                            │
└─────────────────────────────────────────────────────┘
```

### MCP管理员智能体界面

用户点击"呼叫管理员"后，在设置窗口右侧展开终端界面：

```
🤖 MCP工具管理员                          [收起]
┌─────────────────────────────────────────┐
│ 你好！我是专门负责MCP工具管理的智能助手。 │
│ 我将帮你找到并安装合适的工具。           │
│                                      │
│ 🔍 正在分析你的需求: "我需要连接Redis"   │
│                                      │
│ 📋 找到以下相关工具:                   │
│ 1. redis-mcp-server                   │
│    - 作者: @redis-team                 │
│    - 功能: 连接Redis进行数据操作        │
│    - 评分: ⭐⭐⭐⭐⭐                   │
│                                      │
│ 2. ioredis-mcp                        │
│    - 作者: @ioredis-community          │
│    - 功能: 高性能Redis客户端           │
│    - 评分: ⭐⭐⭐⭐                     │
│                                      │
│ 💡 推荐使用第一个，它更稳定且维护活跃。   │
│                                      │
│ 🚀 是否现在安装 redis-mcp-server？     │
│ 我将自动配置到你的Claude环境中。        │
│                                      │
│ 用户: 好的，请安装                     │
│                                      │
│ ✅ 正在安装...                        │
│ ✅ 已下载工具包                       │
│ ✅ 已更新配置文件                     │
│ ✅ 已验证工具可用性                   │
│                                      │
│ 🎉 安装完成！Redis工具已可用。         │
│ 你现在可以在任务中使用Redis相关功能了。  │
│                                      │
│ 还需要安装其他工具吗？                 │
│                                      │
│ 用户输入: ┃                           │
└─────────────────────────────────────────┘
```

## 技术架构

### 前端组件

1. **SettingsModal组件** (`settings_modal.js`)
   - 管理设置弹窗的显示/隐藏
   - 处理左侧选项切换
   - 集成MCP管理界面

2. **MCPManagerInterface组件** 
   - 显示已安装MCP工具列表
   - 提供用户需求输入界面
   - 管理智能体会话状态

3. **MCPAgentTerminal组件**
   - 基于现有SessionTerminal扩展
   - 专门处理MCP管理员智能体交互
   - 支持实时对话和命令执行

### 后端集成

1. **WebSocket路由扩展**
   ```python
   @app.websocket("/settings-mcp")
   async def settings_mcp_websocket(websocket):
       """设置窗口中的MCP管理会话"""
       # 处理MCP管理员智能体交互
   ```

2. **MCP配置管理API**
   ```python
   @app.get("/api/mcp/status")
   async def get_mcp_status():
       """获取MCP工具状态"""
   
   @app.post("/api/mcp/toggle")  
   async def toggle_mcp_tool():
       """启用/禁用MCP工具"""
   ```

### MCP管理员智能体

**配置文件**: `agents/mcp_manager_agent.md`

**核心能力**:
- 理解用户的工具需求描述
- 搜索GitHub/npm上的MCP服务器
- 评估工具质量和兼容性
- 推荐最合适的工具
- 自动执行安装和配置
- 验证安装结果

**预置命令**:
- `mcp search <query>` - 搜索MCP工具
- `mcp install <package>` - 安装MCP工具
- `mcp list` - 列出已安装工具
- `mcp enable <tool>` - 启用工具
- `mcp disable <tool>` - 禁用工具
- `mcp status` - 查看工具状态

## 用户体验流程

1. **进入设置**: 用户点击侧边栏的settings-btn按钮
2. **选择MCP管理**: 在设置左侧选择"🔧 MCP工具"选项
3. **查看现状**: 右侧显示当前已安装的MCP工具列表和状态
4. **描述需求**: 在输入框中描述需要的工具功能
5. **呼叫管理员**: 点击"呼叫管理员"按钮
6. **智能对话**: 
   - 管理员分析用户需求
   - 自动搜索相关MCP工具
   - 展示搜索结果和推荐理由
   - 征求用户确认
7. **自动安装**: 
   - 下载工具包
   - 更新配置文件
   - 验证安装结果
   - 报告完成状态
8. **完成管理**: 用户可以继续添加其他工具或关闭设置

## 核心优势

1. **零学习成本**: 用户只需用自然语言描述需求
2. **智能推荐**: 自动评估工具质量和兼容性
3. **全自动化**: 安装和配置过程完全自动化
4. **符合产品理念**: 体现"数字员工自主学习"的核心概念
5. **扩展性好**: 可以轻松添加更多智能体功能

## 实现优先级

### Phase 1: 基础框架
- 创建Settings弹窗界面
- 实现MCP工具状态展示
- 建立WebSocket通信机制

### Phase 2: 智能体集成  
- 创建MCP管理员智能体配置
- 实现智能体会话界面
- 测试基础对话功能

### Phase 3: MCP功能集成
- 实现MCP工具搜索功能
- 集成Claude Code的MCP管理命令
- 实现自动安装流程

### Phase 4: 优化和测试
- 完善错误处理
- 优化用户体验
- 端到端测试

## 技术风险评估

1. **Claude Code MCP命令支持**: 需要验证Claude Code是否支持programmatic的MCP管理
2. **智能体响应质量**: 需要优化提示词确保智能体给出准确推荐
3. **工具兼容性**: 不同MCP工具的安装方式可能不同
4. **错误处理**: 需要处理网络问题、权限问题等各种异常情况

## 后续扩展方向

1. **工具市场**: 建立精选MCP工具库
2. **自动更新**: 定期检查和更新已安装工具
3. **使用统计**: 统计工具使用情况和效果
4. **团队共享**: 支持团队间的工具配置共享
5. **自定义开发**: 支持用户开发自定义MCP工具

---

*文档创建时间: 2025-01-14*
*设计者: Claude Code Assistant*